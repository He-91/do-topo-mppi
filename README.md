# Topo-MPPI æ— äººæœºè·¯å¾„è§„åˆ’ç³»ç»Ÿ

## ğŸš€ é¡¹ç›®ç®€ä»‹
åŸºäºFast-Planneræ”¹è¿›çš„ä¸‰å±‚æ— äººæœºè·¯å¾„è§„åˆ’ç³»ç»Ÿï¼š
- **TopoPRM v4.1**ï¼ˆå…¨å±€å¤šæ‹“æ‰‘è·¯å¾„ç”Ÿæˆ + æ™ºèƒ½å›é€€ï¼‰
- **MPPI**ï¼ˆåŠ¨åŠ›å­¦è½¨è¿¹å¹¶è¡Œä¼˜åŒ–ï¼‰
- **B-spline**ï¼ˆè½¨è¿¹å¹³æ»‘ï¼‰

## ğŸ†• æœ€æ–°æ›´æ–° (2025-10-07)

âœ… **å·²å®Œæˆéšœç¢ç‰©å¯†åº¦åŠ å€æµ‹è¯•**
- Fast-Planneråœ°å›¾ï¼š**300æŸ±å­ + 20åœ†åœˆ = 320ä¸ªéšœç¢ç‰©** (ä»160ä¸ªåŠ å€)
- åœ°å›¾å¤§å°ï¼š40m Ã— 20m Ã— 5m
- ç‚¹äº‘æ•°é‡ï¼š~450,000 ç‚¹
- RVizé…è‰²ä¼˜åŒ–ï¼šç±³é»„è‰²èƒŒæ™¯ + è“è‰²åŠé€æ˜éšœç¢ç‰©
- æ‰€æœ‰é…ç½®é—®é¢˜å·²ä¿®å¤ï¼ˆåœ°å›¾é¢œè‰²ã€æ— äººæœºæ¨¡å‹ã€so3é”™è¯¯ï¼‰

---

## ğŸ“Š æœ€ç»ˆæ€§èƒ½æŒ‡æ ‡ (v4.0 ä¼˜åŒ–å®Œæˆ)

### æ ¸å¿ƒæˆæœå¯¹æ¯”
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘      æŒ‡æ ‡          â•‘  v1.0     â•‘  v2.0     â•‘  v3.0     â•‘  v4.0     â•‘
â•‘                    â•‘  (K=18)   â•‘  (K=22)   â•‘  (K=28    â•‘ (K=28     â•‘
â•‘                    â•‘  å´©æºƒç‰ˆ    â•‘  æ¢å¤ç‰ˆ   â•‘  150ms)   â•‘  200ms)   â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ PRMæˆåŠŸç‡          â•‘    0%     â•‘   71.0%   â•‘   70.0%   â•‘   87.1%   â•‘
â•‘ Legacyå›é€€ç‡       â•‘  100.0%   â•‘   29.0%   â•‘   30.0%   â•‘   12.9%   â•‘
â•‘ å•è·¯å¾„ç‡           â•‘   50.0%   â•‘   29.0%   â•‘   26.7%   â•‘   22.6%   â•‘
â•‘ å¹³å‡è·¯å¾„æ•°         â•‘   2.63    â•‘   3.16    â•‘   2.63    â•‘   3.10    â•‘
â•‘ DFSæˆåŠŸç‡          â•‘    0%     â•‘   ~71%    â•‘   46.3%   â•‘   87.1%   â•‘
â•‘ B-splineæˆåŠŸç‡     â•‘    -      â•‘   96.7%   â•‘   86.7%   â•‘   87.1%   â•‘
â•‘ æ€»æˆåŠŸç‡           â•‘  100%     â•‘   96.8%   â•‘  100%     â•‘  100%     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•
```

### v4.0 è·¯å¾„è´¨é‡åˆ†å¸ƒ (31æ¬¡æµ‹è¯•)
```
1è·¯å¾„:  7æ¬¡ (22.6%)  âœ… ä½äº30%ç›®æ ‡
2è·¯å¾„:  3æ¬¡ ( 9.7%)
3è·¯å¾„: 10æ¬¡ (32.3%)  â­ æœ€ä¼˜å æ¯”
4è·¯å¾„:  7æ¬¡ (22.6%)
5+è·¯å¾„: 4æ¬¡ (12.9%)  âœ¨ å¤æ‚åœºæ™¯å¤šæ ·æ€§
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å¹³å‡: 3.10æ¡è·¯å¾„
```

### å…³é”®çªç ´
- âœ… **å•è·¯å¾„ç‡ä»50%é™è‡³22.6%** (-54.8%æ”¹è¿›)
- âœ… **Legacyå›é€€ä»100%é™è‡³12.9%** (PRMä¸»å¯¼)
- âœ… **DFSæˆåŠŸç‡ä»0%å‡è‡³87.1%** (è¿é€šæ€§ä¿è¯)
- âœ… **å¹³å‡è·¯å¾„3.10æ¡** (ç†æƒ³å¤šæ ·æ€§)
- âœ… **100%è§„åˆ’æˆåŠŸç‡** (å¯é æ€§ä¿è¯)

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
EGO-Planner Manager
    â”‚
    â”œâ”€ STEP 1: Topological Planning (TopoPRM v4.0)
    â”‚   â”œâ”€ ğŸ“ æ¤­çƒè‡ªç”±ç©ºé—´é‡‡æ · (135èŠ‚ç‚¹: 100æ ¸å¿ƒ+35è¾¹ç•Œ)
    â”‚   â”œâ”€ ğŸŒ å¯è§æ€§å›¾æ„å»º (K=28 KNN, å¹³å‡åº¦33.5)
    â”‚   â”œâ”€ ğŸ” DFSå¤šè·¯å¾„æœç´¢ (200ms timeout, æ™ºèƒ½å‰ªæ)
    â”‚   â”œâ”€ â™»ï¸  æ‹“æ‰‘å»é‡ (Hausdorffè·ç¦», 3.5%é˜ˆå€¼)
    â”‚   â””â”€ ğŸ”„ Legacyå›é€€ (PRMå¤±è´¥æ—¶, åˆ‡çº¿ç‚¹æ³•+å»é‡)
    â”‚
    â”œâ”€ STEP 1.5: Parallel MPPI Optimization
    â”‚   â””â”€ å¤šè·¯å¾„å¹¶è¡Œä¼˜åŒ–, æŒ‡æ•°åŠ æƒé€‰ä¼˜
    â”‚
    â””â”€ STEP 3: B-spline Smoothing
        â””â”€ è½¨è¿¹å¹³æ»‘ä¸è½»å¾®é¿éšœ
```

---

## âš™ï¸ æ ¸å¿ƒå‚æ•°é…ç½® (v4.0 æœ€ä¼˜)

### TopoPRMå‚æ•°
```cpp
// å›¾æ„å»ºå‚æ•° (topo_prm.cpp)
int K = 28;                          // KNNè¿æ¥æ•° (ä»18â†’22â†’28ä¼˜åŒ–)
const double MAX_DFS_TIME_MS = 200.0; // DFSè¶…æ—¶ (ä»150msâ†’200ms)
int core_samples = 100;              // æ ¸å¿ƒé‡‡æ ·ç‚¹
int boundary_samples = 35;           // è¾¹ç•Œé‡‡æ ·ç‚¹

// å»é‡å‚æ•°
double hausdorff_threshold = 0.035;  // 3.5% Hausdorffè·ç¦»
```

### Legacyå›é€€å‚æ•°
```cpp
// åˆ‡çº¿ç‚¹ç”Ÿæˆ
int num_obstacles = 12;              // éšœç¢ç‰©æ•°é‡
double safety_margin = 4.5;          // å®‰å…¨è·ç¦»(m)
```

### æ€§èƒ½å‚æ•°
```cpp
// è·¯å¾„é™åˆ¶
max_raw_paths_ = 50;                 // DFSæœ€å¤§æœç´¢è·¯å¾„
reserve_num_ = 8;                    // ä¿ç•™è·¯å¾„æ•°
ratio_to_short_ = 2.5;               // æœ€é•¿=æœ€çŸ­*2.5
```

---

## ğŸ¯ ä¼˜åŒ–å†ç¨‹æ€»ç»“

### Phase 1: K=18å´©æºƒè¯Šæ–­ (v1.0)
**é—®é¢˜**: 100% Legacyå›é€€, 50%å•è·¯å¾„ç‡
**åŸå› **: K=18è¿é€šæ€§ä¸è¶³, start/goalå­¤ç«‹
**è¡ŒåŠ¨**: æ¢å¤K=22

### Phase 2: K=22åŸºæœ¬æ¢å¤ (v2.0)
**æˆæœ**: 71% PRMæˆåŠŸ, 29%å•è·¯å¾„ç‡
**é—®é¢˜**: ä»æœ‰29% Legacyå›é€€, è·¯å¾„å¶æœ‰é‡å¤
**è¡ŒåŠ¨**: å®ç°Legacyå»é‡

### Phase 3: Legacyå»é‡å®ç° (v3.0-early)
**æˆæœ**: å»é‡ç‡83.3% (6è·¯å¾„â†’1è·¯å¾„æ¡ˆä¾‹)
**é—®é¢˜**: æ€§èƒ½ç•¥é™, å•è·¯å¾„ç‡26.7%
**è¡ŒåŠ¨**: æå‡Kåˆ°28

### Phase 4: K=28è¿é€šæ€§æå‡ (v3.0)
**é—®é¢˜**: å›¾å¤æ‚åº¦å¢åŠ , DFSè¶…æ—¶53.7%
**å‘ç°**: ä¸æ˜¯è¿é€šæ€§é—®é¢˜, æ˜¯æœç´¢æ—¶é—´ä¸è¶³
**è¡ŒåŠ¨**: DFS timeout 150msâ†’200ms

### Phase 5: 200ms timeoutæœ€ç»ˆä¼˜åŒ– (v4.0) âœ…
**æˆæœ**: 
- DFSæˆåŠŸç‡87.1% (+88%æå‡)
- Legacyå›é€€12.9% (-57%é™ä½)
- å•è·¯å¾„ç‡22.6% (å†å²æœ€ä½)
- å¹³å‡è·¯å¾„3.10æ¡ (ç†æƒ³çŠ¶æ€)

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¼–è¯‘
```bash
cd /home/he/ros_ws/test/topo-mppi
catkin_make -DCATKIN_WHITELIST_PACKAGES="path_searching;plan_manage" -j4
source devel/setup.bash
```

### è¿è¡Œä»¿çœŸ

#### Fast-Planneråœ°å›¾æµ‹è¯• (æ¨è) â­

**é…ç½®**: 320ä¸ªéšœç¢ç‰© (300æŸ±å­ + 20åœ†åœˆ), 40Ã—20Ã—5m åœ°å›¾

**ç»ˆç«¯ 1 - å¯åŠ¨ç³»ç»Ÿ:**
```bash
docker exec -it 65abafec5dc5 bash -c "cd /home/developer/ros_ws/topo-mppi && source devel/setup.bash && roslaunch ego_planner topo_mppi_fastplanner_map.launch"
```
ç­‰å¾…çœ‹åˆ° `[FSM]: state: WAIT_TARGET` è¡¨ç¤ºç³»ç»Ÿå°±ç»ª

**ç»ˆç«¯ 2 - å¯åŠ¨RViz (æœ€ä½³é…è‰²):**
```bash
xhost +local:docker
docker exec -it 65abafec5dc5 bash -c "cd /home/developer/ros_ws/topo-mppi && source devel/setup.bash && export DISPLAY=:0 && rviz -d src/planner/plan_manage/launch/fastplanner_test.rviz"
```
åº”è¯¥çœ‹åˆ°:
- ğŸŸ¡ **ç±³é»„è‰²èƒŒæ™¯** (èˆ’é€‚é…è‰²)
- ğŸŸ¦ **è“è‰²åŠé€æ˜éšœç¢ç‰©** (Boxesæ ·å¼, Alpha 0.2)
- ğŸš **æ— äººæœºmeshæ¨¡å‹** (èµ·ç‚¹: x=-19, y=0, z=1)
- ğŸ“Š **æ‰€æœ‰è·¯å¾„å¯è§†åŒ–** (topo paths, mppi trajectoriesç­‰)

**ç»ˆç«¯ 3 - å‘é€æµ‹è¯•ç›®æ ‡:**
```bash
docker exec 65abafec5dc5 bash -c "source /home/developer/ros_ws/topo-mppi/devel/setup.bash && rostopic pub -1 /move_base_simple/goal geometry_msgs/PoseStamped '{header: {stamp: now, frame_id: \"world\"}, pose: {position: {x: 10.0, y: 0.0, z: 1.0}, orientation: {w: 1.0}}}'"
```

**æµ‹è¯•ç›®æ ‡å»ºè®®:**
- è¿‘è·ç¦»: `(10, 0, 1)` - æµ‹è¯•åŸºæœ¬è§„åˆ’
- ä¸­è·ç¦»: `(0, 10, 1)` - æµ‹è¯•æ‹“æ‰‘å¤šæ ·æ€§
- è¿œè·ç¦»: `(15, 8, 1)` - æµ‹è¯•å¤æ‚é¿éšœ

#### åŸmockamapæµ‹è¯•
```bash
# å¯åŠ¨å®Œæ•´ä»¿çœŸ
roslaunch plan_manage run_in_sim.launch

# å¯åŠ¨MPPIå¯è§†åŒ–æµ‹è¯•
roslaunch plan_manage test_mppi_visualization.launch
```

### RVizå¯è§†åŒ–
- `/map_generator/global_cloud` - å…¨å±€åœ°å›¾ç‚¹äº‘ (ç™½è‰²)
- `/topo_paths` - å½©è™¹è‰²æ‹“æ‰‘è·¯å¾„ (MarkerArray)
- `/mppi_trajectories` - MPPIé‡‡æ ·è½¨è¿¹ (æƒé‡ç€è‰²)
- `/mppi_optimal_trajectory` - æœ€ä¼˜è½¨è¿¹ (è“è‰²é€Ÿåº¦ç®­å¤´)
- `/topo_mppi_paths` - TOPO+MPPIç»„åˆè·¯å¾„
- `/odom_visualization/path` - æ— äººæœºé£è¡Œè½¨è¿¹ (ç»¿è‰²)

---

## ğŸ“ˆ æ€§èƒ½åˆ†æå·¥å…·

### å®æ—¶æ—¥å¿—ç»Ÿè®¡
```bash
# æŸ¥çœ‹Legacyå›é€€ç‡
grep -c "Legacy Generation Summary" <log_file>

# æŸ¥çœ‹DFSè¶…æ—¶ç‡
grep "200\.0ms\|200\.1ms" <log_file> | wc -l

# ç»Ÿè®¡è·¯å¾„åˆ†å¸ƒ
grep "Topological planning succeeded, found" <log_file> | \
  grep -o "found [0-9]* paths" | grep -o "[0-9]*" | \
  awk '{sum+=$1; count++; if($1==1) single++} 
       END {print "å¹³å‡:", sum/count, "å•è·¯å¾„ç‡:", single/count*100"%"}'
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜
1. **é«˜Legacyå›é€€ç‡ (>20%)**
   - æ£€æŸ¥Kå€¼æ˜¯å¦è¶³å¤Ÿ (å»ºè®®â‰¥28)
   - æ£€æŸ¥DFS timeout (å»ºè®®200ms)
   - æŸ¥çœ‹start/goalè¿é€šåº¦æ—¥å¿—

2. **é«˜å•è·¯å¾„ç‡ (>30%)**
   - å¢åŠ DFS timeout
   - é™ä½å»é‡é˜ˆå€¼ (3.5%â†’5%)
   - å¢åŠ Kå€¼

3. **DFSè¶…æ—¶è¿‡å¤š (>15%)**
   - å¢åŠ timeoutåˆ°250ms
   - æ£€æŸ¥é‡‡æ ·è´¨é‡
   - æŸ¥çœ‹éšœç¢ç‰©å¯†åº¦

---

## ğŸ“š æŠ€æœ¯ç»†èŠ‚

### æ‹“æ‰‘å»é‡ç®—æ³•
ä½¿ç”¨Hausdorffè·ç¦»åˆ¤æ–­è·¯å¾„æ‹“æ‰‘ç­‰ä»·æ€§:
```cpp
double hausdorff_dist = computeHausdorffDistance(path1, path2);
if (hausdorff_dist < threshold * path_length) {
    // è®¤ä¸ºæ˜¯é‡å¤è·¯å¾„
}
```

### Legacyå›é€€æœºåˆ¶
PRMå¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°åˆ‡çº¿ç‚¹æ³•:
```cpp
if (dfs_timeout && paths.size() == 0) {
    ROS_WARN("PRMå¤±è´¥, å¯åŠ¨Legacyæ¨¡å¼");
    findTopoPathsLegacy();  // åŒ…å«Hausdorffå»é‡
}
```

### è¿é€šæ€§é¢„æ£€
```cpp
if (start_degree < 5 || goal_degree < 5) {
    ROS_WARN("è¿é€šæ€§ä¸è¶³: start_deg=%d, goal_deg=%d", 
             start_degree, goal_degree);
}
```

---

## ğŸ“ ç‰ˆæœ¬å†å²

- **v1.0** (2025-10-03): K=18å´©æºƒç‰ˆ, 100% Legacy
- **v2.0** (2025-10-04): K=22æ¢å¤ç‰ˆ, 71% PRM
- **v3.0** (2025-10-05): K=28 + Legacyå»é‡
- **v4.0** (2025-10-05): 200ms timeout, ç”Ÿäº§å°±ç»ª âœ…
- **v4.1** (2025-10-06): Fast-Planneråœ°å›¾é›†æˆ + 2Dæµ‹è¯•æ”¯æŒ
- **v4.2** (2025-10-07): éšœç¢ç‰©å¯†åº¦åŠ å€æµ‹è¯• + RVizé…è‰²ä¼˜åŒ– ğŸ†•

---

## ï¿½ ä¿®å¤è®°å½• (v4.2)

### å·²è§£å†³çš„é—®é¢˜
1. âœ… **åœ°å›¾é¢œè‰²é”™è¯¯** - æ¢å¤ç±³é»„è‰²èƒŒæ™¯ + è“è‰²åŠé€æ˜éšœç¢ç‰©
2. âœ… **æ— äººæœºæ¨¡å‹ç¼ºå¤±** - æ·»åŠ  `/odom_visualization/robot` meshæ˜¾ç¤º
3. âœ… **so3_disturbance_generatoré”™è¯¯** - ç§»é™¤ä¸å­˜åœ¨çš„åŒ…å¼•ç”¨
4. âœ… **RVizé…ç½®æ··ä¹±** - ç»Ÿä¸€ä½¿ç”¨ `fastplanner_test.rviz`
5. âœ… **éšœç¢ç‰©å¯†åº¦** - ä»160ä¸ªåŠ å€åˆ°320ä¸ª (300æŸ±+20åœ†)

### é…ç½®æ–‡ä»¶è¯´æ˜
- `topo_mppi_fastplanner_map.launch` - Fast-Planneråœ°å›¾å¯åŠ¨æ–‡ä»¶ (320éšœç¢ç‰©)
- `fastplanner_test.rviz` - æœ€ä½³RVizé…è‰²é…ç½®
- `simulator.xml` - å·²ç§»é™¤so3_disturbance_generatorèŠ‚ç‚¹
- `advanced_param.xml` - TopoPRM+MPPIä¼˜åŒ–å‚æ•°

---

## ğŸ“ å‚è€ƒèµ„æ–™
- [Fast-Planner](https://github.com/HKUST-Aerial-Robotics/Fast-Planner) - åŸå§‹PRMå®ç°
- [EGO-Planner](https://github.com/ZJU-FAST-Lab/ego-planner) - åŸºç¡€æ¡†æ¶
- [TGK-Planner](https://github.com/ZJU-FAST-Lab/TGK-Planner) - æ‹“æ‰‘è·¯å¾„å‚è€ƒ

---

**æœ€åæ›´æ–°**: 2025-10-07  
**å½“å‰ç‰ˆæœ¬**: v4.2 (Production Ready + Doubled Obstacles)  
**æµ‹è¯•ç¯å¢ƒ**: Docker 65abafec5dc5, ROS Noetic  
**æ¨èé…ç½®**: K=28, DFS timeout=200ms, 320éšœç¢ç‰©
